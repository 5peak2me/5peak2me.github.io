<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Activity启动过程分析(从Launcher启动) · J!nl!n's Blog</title><meta name="description" content="Activity启动过程分析(从Launcher启动) - J!nl!n"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://daijinlin.com/atom.xml" title="J!nl!n's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/5peak2me" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Activity启动过程分析(从Launcher启动)</h1><div class="post-info">Feb 21, 2017</div><div class="post-content"><p>　　<strong> 概述：</strong>在Android系统中，Activity是应用程序的四大组件之一，在开发Android应用时无时无刻都在使用它们。但是它们的启动过程是怎么样的？Activity的什么周期方法到底是怎么被执行？本篇将结合源码（7.0.0_r1）进行分析。<br><a id="more"></a></p>
<p>先来看看启动调用的时序图<br><img src="http://ooackh347.bkt.clouddn.com/UML_%E4%BB%8ELaucher%E5%90%AF%E5%8A%A8Activity%E8%BF%87%E7%A8%8B.png" alt></p>
<p>源码:<code>packages/apps/Launcher3/src/com/android/launcher3/Launcher.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Launcher</span> <span class="keyword">extends</span> <span class="title">Activity</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span>, <span class="title">OnLongClickListener</span>, <span class="title">LauncherModel</span>.<span class="title">Callbacks</span>,<span class="title">View</span>.<span class="title">OnTouchListener</span>, <span class="title">PageSwitchListener</span>, <span class="title">LauncherProviderChangeListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...省略代码专用...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Launches the intent referred by the clicked shortcut.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> v The view representing the clicked shortcut.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ...省略代码专用...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (v <span class="keyword">instanceof</span> Workspace) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mWorkspace.isInOverviewMode()) &#123;</span><br><span class="line">                showWorkspace(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (v <span class="keyword">instanceof</span> CellLayout) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mWorkspace.isInOverviewMode()) &#123;</span><br><span class="line">                showWorkspace(mWorkspace.indexOfChild(v), <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object tag = v.getTag();</span><br><span class="line">        <span class="keyword">if</span> (tag <span class="keyword">instanceof</span> ShortcutInfo) &#123;</span><br><span class="line">            onClickAppShortcut(v);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag <span class="keyword">instanceof</span> FolderInfo) &#123;</span><br><span class="line">            <span class="keyword">if</span> (v <span class="keyword">instanceof</span> FolderIcon) &#123;</span><br><span class="line">                onClickFolderIcon(v);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (v == mAllAppsButton) &#123;</span><br><span class="line">            onClickAllAppsButton(v);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag <span class="keyword">instanceof</span> AppInfo) &#123;</span><br><span class="line">            startAppShortcutOrInfoActivity(v);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag <span class="keyword">instanceof</span> LauncherAppWidgetInfo) &#123;</span><br><span class="line">            <span class="keyword">if</span> (v <span class="keyword">instanceof</span> PendingAppWidgetHostView) &#123;</span><br><span class="line">                onClickPendingWidget((PendingAppWidgetHostView) v);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...省略代码专用...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Android</code>中桌面的应用程序都是由<code>Launcher</code>启动的，其中<code>Launcher</code>本身也是一个应用，当应用程序安装完成后都会在桌面创建相应的应用程序图标，点击这个图标，<code>Launcher</code>就会将其启动起来。桌面其实用了一个<code>RecyclerView</code>来构建，具体请看<code>AllAppsContainerView</code>源码。当我们点击图标的时候，则直接执行<code>onClickAppShortcut</code>方法，来看其代码</p>
<p>源码:<code>packages/apps/Launcher3/src/com/android/launcher3/Launcher.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Event handler for an app shortcut click.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> v The view that was clicked. Must be a tagged with a &#123;<span class="doctag">@link</span> ShortcutInfo&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onClickAppShortcut</span><span class="params">(<span class="keyword">final</span> View v)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...省略代码专用...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Open shortcut</span></span><br><span class="line">    <span class="keyword">final</span> ShortcutInfo shortcut = (ShortcutInfo) tag;</span><br><span class="line"></span><br><span class="line">    ...省略代码专用...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check for abandoned promise</span></span><br><span class="line">    <span class="keyword">if</span> ((v <span class="keyword">instanceof</span> BubbleTextView)</span><br><span class="line">            &amp;&amp; shortcut.isPromise()</span><br><span class="line">            &amp;&amp; !shortcut.hasStatusFlag(ShortcutInfo.FLAG_INSTALL_SESSION_ACTIVE)) &#123;</span><br><span class="line">        showBrokenAppInstallDialog(</span><br><span class="line">                shortcut.getTargetComponent().getPackageName(),</span><br><span class="line">                <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">                        startAppShortcutOrInfoActivity(v);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start activities</span></span><br><span class="line">    startAppShortcutOrInfoActivity(v);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mLauncherCallbacks != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mLauncherCallbacks.onClickAppShortcut(v);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据注释可以看到调用了<code>startAppShortcutOrInfoActivity</code>方法，继续来看</p>
<p>源码:<code>packages/apps/Launcher3/src/com/android/launcher3/Launcher.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Thunk</span> <span class="function"><span class="keyword">void</span> <span class="title">startAppShortcutOrInfoActivity</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...省略代码专用...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> success = startActivitySafely(v, intent, tag);</span><br><span class="line">    mStats.recordLaunch(v, intent, shortcut);</span><br><span class="line"></span><br><span class="line">    ...省略代码专用...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用的是<code>startActivitySafely</code>方法。</p>
<p>源码:<code>packages/apps/Launcher3/src/com/android/launcher3/Launcher.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">startActivitySafely</span><span class="params">(View v, Intent intent, Object tag)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    ...省略代码专用...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        success = startActivity(v, intent, tag);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ActivityNotFoundException e) &#123;</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, R.string.activity_not_found, Toast.LENGTH_SHORT).show();</span><br><span class="line">        Log.e(TAG, <span class="string">"Unable to launch. tag="</span> + tag + <span class="string">" intent="</span> + intent, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其内部调用的就是<code>startActivity</code>方法。</p>
<p>源码:<code>packages/apps/Launcher3/src/com/android/launcher3/Launcher.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">startActivity</span><span class="params">(View v, Intent intent, Object tag)</span> </span>&#123;</span><br><span class="line">    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK); <span class="comment">// ①</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    </span><br><span class="line">        ...省略代码专用...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span> || user.equals(UserHandleCompat.myUserHandle())) &#123;</span><br><span class="line">            StrictMode.VmPolicy oldPolicy = StrictMode.getVmPolicy();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Temporarily disable deathPenalty on all default checks. For eg, shortcuts</span></span><br><span class="line">                <span class="comment">// containing file Uris would cause a crash as penaltyDeathOnFileUriExposure</span></span><br><span class="line">                <span class="comment">// is enabled by default on NYC.</span></span><br><span class="line">                StrictMode.setVmPolicy(<span class="keyword">new</span> StrictMode.VmPolicy.Builder().detectAll()</span><br><span class="line">                        .penaltyLog().build());</span><br><span class="line">                <span class="comment">// Could be launching some bookkeeping activity</span></span><br><span class="line">                startActivity(intent, optsBundle); <span class="comment">// ②</span></span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                StrictMode.setVmPolicy(oldPolicy);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// TODO Component can be null when shortcuts are supported for secondary user</span></span><br><span class="line">            launcherApps.startActivityForProfile(intent.getComponent(), user,</span><br><span class="line">                    intent.getSourceBounds(), optsBundle);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">        ...省略代码专用...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注释1处可以看出新开的<code>Activity</code>是在新的任务栈里面。注释2处调用<code>Activity</code>的<code>startActivity</code>方法</p>
<p>源码:<code>frameworks/base/core/java/android/app/Activity.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">        startActivityForResult(intent, -<span class="number">1</span>, options);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Note we want to go through this call for compatibility with</span></span><br><span class="line">        <span class="comment">// applications that may have overridden the method.</span></span><br><span class="line">        startActivityForResult(intent, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>源码:<code>frameworks/base/core/java/android/app/Activity.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(@RequiresPermission Intent intent, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Instrumentation.ActivityResult ar =</span><br><span class="line">            mInstrumentation.execStartActivity(</span><br><span class="line">                <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</span><br><span class="line">                intent, requestCode, options);</span><br><span class="line">        ...省略代码专用...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...省略代码专用...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>mParent</code>是<code>Activity</code>类型的成员变量，表示当前<code>Activity</code>的父类。因为目前根<code>Activity</code>还没有创建出来，则<code>mParent == null</code>成立。接着调用<code>Instrumentation</code>的<code>execStartActivity</code>方法。<code>execStartActivity</code>方法的代码如下所示。</p>
<p>源码:<code>frameworks/base/core/java/android/app/Instrumentation.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        Context who, IBinder contextThread, IBinder token, Activity target,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span> </span>&#123;</span><br><span class="line">    IApplicationThread whoThread = (IApplicationThread) contextThread;</span><br><span class="line">    Uri referrer = target != <span class="keyword">null</span> ? target.onProvideReferrer() : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (referrer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        intent.putExtra(Intent.EXTRA_REFERRER, referrer);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...省略代码专用...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        intent.migrateExtraStreamToClipData();</span><br><span class="line">        intent.prepareToLeaveProcess(who);</span><br><span class="line">        <span class="keyword">int</span> result = ActivityManagerNative.getDefault()</span><br><span class="line">            .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                    intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                    token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">                    requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line">        checkStartActivityResult(result, intent);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failure from system"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先会调用<code>ActivityManagerNative</code>的<code>getDefault</code>来获取<code>ActivityManageService</code>（后续简称为AMS)的代理对象，接着调用它的<code>startActivity</code>方法。</p>
<p>源码:<code>frameworks/base/core/java/android/app/ActivityManagerNative.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Retrieve the system's default/global activity manager.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gDefault.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IBinder b = ServiceManager.getService(<span class="string">"activity"</span>); <span class="comment">// ①</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">            Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service binder = "</span> + b);</span><br><span class="line">        &#125;</span><br><span class="line">        IActivityManager am = asInterface(b); <span class="comment">// ②</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">            Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service = "</span> + am);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> am;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>getDefault</code>方法调用了<code>gDefault</code>的<code>get</code>方法，我们接着往下看，<code>gDefault</code>是一个单例<code>Singleton</code>。注释1处得到名为<code>”activity”</code>的<code>Service</code>代理对象，实质就是<code>ActivityManagerService</code>的代理对象。接着在注释2处将它封装成<code>ActivityManagerProxy</code>(以后简称为AMP)类型对象，并将它保存到<code>gDefault</code>中，此后调用<code>ActivityManagerNative</code>的<code>getDefault</code>方法就会直接获得AMS的代理AMP对象。<br>回到Instrumentation类的execStartActivity方法中，从上面得知就是调用AMP的startActivity，其中AMP是ActivityManagerNative的内部类，代码如下所示。</p>
<p>源码:<code>frameworks/base/core/java/android/app/ActivityManagerNative.java$ActivityManagerProxy</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    data.writeStrongBinder(caller != <span class="keyword">null</span> ? caller.asBinder() : <span class="keyword">null</span>);</span><br><span class="line">    data.writeString(callingPackage);</span><br><span class="line">    intent.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">    data.writeString(resolvedType);</span><br><span class="line">    data.writeStrongBinder(resultTo);</span><br><span class="line">    data.writeString(resultWho);</span><br><span class="line">    data.writeInt(requestCode);</span><br><span class="line">    data.writeInt(startFlags);</span><br><span class="line">    <span class="keyword">if</span> (profilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        data.writeInt(<span class="number">1</span>);</span><br><span class="line">        profilerInfo.writeToParcel(data, Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        data.writeInt(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">        data.writeInt(<span class="number">1</span>);</span><br><span class="line">        options.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        data.writeInt(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, <span class="number">0</span>); <span class="comment">// ①</span></span><br><span class="line">    reply.readException();</span><br><span class="line">    <span class="keyword">int</span> result = reply.readInt();</span><br><span class="line">    reply.recycle();</span><br><span class="line">    data.recycle();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先会将传入的参数写入到<code>Parcel</code>类型的<code>data</code>中。在注释1处通过<code>IBinder</code>对象<code>mRemote</code>向AMS发送一个<code>START_ACTIVITY_TRANSACTION</code>类型的进程间通信请求。那么服务端AMS就会从<code>Binder</code>线程池中读取我们客户端发来的数据，最终会调用<code>ActivityManagerNative</code>的<code>onTransact</code>方法中执行，如下所示。</p>
<p>源码:<code>frameworks/base/core/java/android/app/ActivityManagerNative.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">    <span class="keyword">case</span> START_ACTIVITY_TRANSACTION:</span><br><span class="line">    &#123;</span><br><span class="line">        data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">        IBinder b = data.readStrongBinder();</span><br><span class="line">        IApplicationThread app = ApplicationThreadNative.asInterface(b);</span><br><span class="line">        String callingPackage = data.readString();</span><br><span class="line">        Intent intent = Intent.CREATOR.createFromParcel(data);</span><br><span class="line">        String resolvedType = data.readString();</span><br><span class="line">        IBinder resultTo = data.readStrongBinder();</span><br><span class="line">        String resultWho = data.readString();</span><br><span class="line">        <span class="keyword">int</span> requestCode = data.readInt();</span><br><span class="line">        <span class="keyword">int</span> startFlags = data.readInt();</span><br><span class="line">        ProfilerInfo profilerInfo = data.readInt() != <span class="number">0</span></span><br><span class="line">                ? ProfilerInfo.CREATOR.createFromParcel(data) : <span class="keyword">null</span>;</span><br><span class="line">        Bundle options = data.readInt() != <span class="number">0</span></span><br><span class="line">                ? Bundle.CREATOR.createFromParcel(data) : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> result = startActivity(app, callingPackage, intent, resolvedType,</span><br><span class="line">                resultTo, resultWho, requestCode, startFlags, profilerInfo, options);</span><br><span class="line">        reply.writeNoException();</span><br><span class="line">        reply.writeInt(result);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...省略代码专用...</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>onTransact</code>中会调用AMS的<code>startActivity</code>方法，代码如下所示。</p>
<p>源码:<code>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">         Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">         <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</span><br><span class="line">             resultWho, requestCode, startFlags, profilerInfo, bOptions,</span><br><span class="line">             UserHandle.getCallingUserId());</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>AMS的<code>startActivity</code>方法中直接返回了<code>startActivityAsUser</code>方法：</p>
<p>源码:<code>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"startActivity"</span>);</span><br><span class="line">    userId = mUserController.handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(),</span><br><span class="line">            userId, <span class="keyword">false</span>, ALLOW_FULL_ONLY, <span class="string">"startActivity"</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></span><br><span class="line">    <span class="keyword">return</span> mActivityStarter.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent,</span><br><span class="line">            resolvedType, <span class="keyword">null</span>, <span class="keyword">null</span>, resultTo, resultWho, requestCode, startFlags,</span><br><span class="line">            profilerInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, bOptions, <span class="keyword">false</span>, userId, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>startActivityAsUser</code>方法中又返回了<code>mActivityStarter</code>的<code>startActivityMayWait</code>方法，代码如下所示。</p>
<p>源码:<code>frameworks/base/services/core/java/com/android/server/am/ActivityStarter.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">         String callingPackage, Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">         IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">         IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">         ProfilerInfo profilerInfo, IActivityManager.WaitResult outResult, Configuration config,</span></span></span><br><span class="line"><span class="function"><span class="params">         Bundle bOptions, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">         IActivityContainer iContainer, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">         </span><br><span class="line">     ...省略代码专用...</span><br><span class="line">    </span><br><span class="line">     <span class="keyword">int</span> res = startActivityLocked(caller, intent, ephemeralIntent, resolvedType,</span><br><span class="line">             aInfo, rInfo, voiceSession, voiceInteractor,</span><br><span class="line">             resultTo, resultWho, requestCode, callingPid,</span><br><span class="line">             callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,</span><br><span class="line">             options, ignoreTargetSecurity, componentSpecified, outRecord, container,</span><br><span class="line">             inTask);</span><br><span class="line">             </span><br><span class="line">     ...省略代码专用...</span><br><span class="line">     </span><br><span class="line">     <span class="keyword">return</span> res;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>内部又调用了<code>startActivityLocked</code>方法，代码如下所示。</p>
<p>源码:<code>frameworks/base/services/core/java/com/android/server/am/ActivityStarter.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityLocked</span><span class="params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span></span></span><br><span class="line"><span class="function"><span class="params">       String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">       IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">       IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">       String callingPackage, <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">       ActivityOptions options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified,</span></span></span><br><span class="line"><span class="function"><span class="params">       ActivityRecord[] outActivity, ActivityStackSupervisor.ActivityContainer container,</span></span></span><br><span class="line"><span class="function"><span class="params">       TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">    ...省略代码专用...</span><br><span class="line">    </span><br><span class="line">    doPendingActivityLaunchesLocked(<span class="keyword">false</span>);</span><br><span class="line">    </span><br><span class="line">    ...省略代码专用...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>startActivityLocked</code>函数代码非常多，我们只需要关注<code>doPendingActivityLaunchesLocked</code>方法，代码如下所示。</p>
<p>源码:<code>frameworks/base/services/core/java/com/android/server/am/ActivityStarter.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">doPendingActivityLaunchesLocked</span><span class="params">(<span class="keyword">boolean</span> doResume)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">while</span> (!mPendingActivityLaunches.isEmpty()) &#123;</span><br><span class="line">       <span class="keyword">final</span> PendingActivityLaunch pal = mPendingActivityLaunches.remove(<span class="number">0</span>);</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">boolean</span> resume = doResume &amp;&amp; mPendingActivityLaunches.isEmpty();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> result = startActivityUnchecked(</span><br><span class="line">                   pal.r, pal.sourceRecord, <span class="keyword">null</span>, <span class="keyword">null</span>, pal.startFlags, resume, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">           postStartActivityUncheckedProcessing(</span><br><span class="line">                   pal.r, result, mSupervisor.mFocusedStack.mStackId, mSourceRecord,</span><br><span class="line">                   mTargetStack);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           Slog.e(TAG, <span class="string">"Exception during pending activity launch pal="</span> + pal, e);</span><br><span class="line">           pal.sendErrorResult(e.getMessage());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着又调用<code>startActivityUnchecked</code>方法：</p>
<p>源码:<code>frameworks/base/services/core/java/com/android/server/am/ActivityStarter.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityUnchecked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">       IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">   ...省略代码专用...  </span><br><span class="line"> </span><br><span class="line">   mSupervisor.resumeFocusedStackTopActivityLocked(); </span><br><span class="line">     </span><br><span class="line">   ...省略代码专用... </span><br><span class="line"> </span><br><span class="line">   <span class="keyword">return</span> START_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>startActivityUnchecked</code>方法中调用了<code>ActivityStackSupervisor</code>类型的<code>mSupervisor</code>的<code>resumeFocusedStackTopActivityLocked</code>方法，如下所示。<br>源码:<code>frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">resumeFocusedStackTopActivityLocked</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">           ActivityStack targetStack, ActivityRecord target, ActivityOptions targetOptions)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (targetStack != <span class="keyword">null</span> &amp;&amp; isFocusedStack(targetStack)) &#123;</span><br><span class="line">       <span class="keyword">return</span> targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">final</span> ActivityRecord r = mFocusedStack.topRunningActivityLocked();</span><br><span class="line">   <span class="keyword">if</span> (r == <span class="keyword">null</span> || r.state != RESUMED) &#123;</span><br><span class="line">       mFocusedStack.resumeTopActivityUncheckedLocked(<span class="keyword">null</span>, <span class="keyword">null</span>); <span class="comment">// ①</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在注释1处又调用了<code>ActivityStack</code>类型<code>mFocusedStack</code>的<code>resumeTopActivityUncheckedLocked</code>方法：</p>
<p>源码:<code>frameworks/base/services/core/java/com/android/server/am/ActivityStack.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">resumeTopActivityUncheckedLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...省略代码专用...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    </span><br><span class="line">        ...省略代码专用...</span><br><span class="line">       </span><br><span class="line">        result = resumeTopActivityInnerLocked(prev, options);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mStackSupervisor.inResumeTopActivity = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>紧接着查看<code>ActivityStack</code>的<code>resumeTopActivityInnerLocked</code>方法：</p>
<p>源码:<code>frameworks/base/services/core/java/com/android/server/am/ActivityStack.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityInnerLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	...省略代码专用...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the first activity that is not finishing.</span></span><br><span class="line">    <span class="keyword">final</span> ActivityRecord next = topRunningActivityLocked();</span><br><span class="line">        </span><br><span class="line">    ...省略代码专用...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (next.app != <span class="keyword">null</span> &amp;&amp; next.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">       ...省略代码专用...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   </span><br><span class="line">       ...省略代码专用...</span><br><span class="line">    	</span><br><span class="line">       mStackSupervisor.startSpecificActivityLocked(next, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">       </span><br><span class="line">    ...省略代码专用...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>resumeTopActivityInnerLocked</code>方法代码非常多，我们只需要关注调用了<code>ActivityStackSupervisor</code>类型<code>mStackSupervisor</code>的<code>startSpecificActivityLocked</code>方法，代码如下所示。<br>源码:<code>frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startSpecificActivityLocked</span><span class="params">(ActivityRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> </span>&#123;</span><br><span class="line">  ProcessRecord app = mService.getProcessRecordLocked(r.processName,</span><br><span class="line">          r.info.applicationInfo.uid, <span class="keyword">true</span>);</span><br><span class="line">  r.task.stack.setLaunchTime(r);</span><br><span class="line">  <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123; <span class="comment">// 1</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> ((r.info.flags&amp;ActivityInfo.FLAG_MULTIPROCESS) == <span class="number">0</span></span><br><span class="line">                  || !<span class="string">"android"</span>.equals(r.info.packageName)) &#123;</span><br><span class="line">              app.addPackage(r.info.packageName, r.info.applicationInfo.versionCode,</span><br><span class="line">                      mService.mProcessStats);</span><br><span class="line">          &#125;</span><br><span class="line">          realStartActivityLocked(r, app, andResume, checkConfig);<span class="comment">//2</span></span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">          Slog.w(TAG, <span class="string">"Exception when starting activity "</span></span><br><span class="line">                  + r.intent.getComponent().flattenToShortString(), e);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class="keyword">true</span>, <span class="number">0</span>,</span><br><span class="line">          <span class="string">"activity"</span>, r.intent.getComponent(), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在注释1处如果当前<code>Activity</code>所在的<code>Application</code>运行的话，会执行注释2处的代码。<code>realStartActivityLocked</code>方法的代码如下所示。</p>
<p>源码:<code>frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r, ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">          </span><br><span class="line">   ...省略代码专用...</span><br><span class="line">   </span><br><span class="line">      app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</span><br><span class="line">              System.identityHashCode(r), r.info, <span class="keyword">new</span> Configuration(mService.mConfiguration),</span><br><span class="line">              <span class="keyword">new</span> Configuration(task.mOverrideConfig), r.compat, r.launchedFromPackage,</span><br><span class="line">              task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,</span><br><span class="line">              newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</span><br><span class="line">              </span><br><span class="line">  ...省略代码专用...      </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的<code>app.thread</code>指的是<code>IApplicationThread</code>，它的实现是<code>ActivityThread</code>的内部类<code>ApplicationThread</code>，其中<code>ApplicationThread</code>继承了<code>ApplicationThreadNative</code>，而<code>ApplicationThreadNative</code>继承了<code>Binder</code>并实现了<code>IApplicationThread</code>接口。在应用程序进程启动时会创建<code>ActivityThread</code>实例。<code>ActivityThread</code>作为应用程序进程的核心类，它是如何启动应用程序<code>Activity</code>的呢？接着往下看。接着查看<code>ApplicationThread</code>的<code>scheduleLaunchActivity</code>方法，代码如下所示。</p>
<p>源码:<code>frameworks/base/core/java/android/app/ActivityThread.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">        CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> procState, Bundle state, PersistableBundle persistentState,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward, ProfilerInfo profilerInfo)</span> </span>&#123;</span><br><span class="line"> updateProcessState(procState, <span class="keyword">false</span>);</span><br><span class="line">    ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord();</span><br><span class="line">    r.token = token;</span><br><span class="line">    r.ident = ident;</span><br><span class="line">    r.intent = intent;</span><br><span class="line">    r.referrer = referrer;</span><br><span class="line">    r.voiceInteractor = voiceInteractor;</span><br><span class="line">    r.activityInfo = info;</span><br><span class="line">    r.compatInfo = compatInfo;</span><br><span class="line">    r.state = state;</span><br><span class="line">    r.persistentState = persistentState;</span><br><span class="line">    r.pendingResults = pendingResults;</span><br><span class="line">    r.pendingIntents = pendingNewIntents;</span><br><span class="line">    r.startsNotResumed = notResumed;</span><br><span class="line">    r.isForward = isForward;</span><br><span class="line">    r.profilerInfo = profilerInfo;</span><br><span class="line">    r.overrideConfig = overrideConfig;</span><br><span class="line">    updatePendingConfiguration(curConfig);</span><br><span class="line">    sendMessage(H.LAUNCH_ACTIVITY, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>scheduleLaunchActivity</code>方法会将启动<code>Activity</code>的参数封装成<code>ActivityClientRecord</code>，再将<code>ActivityClientRecord</code>通过<code>sendMessage</code>方法向应用进程的主线程发送类型为<code>LAUNCH_ACTIVITY</code>的消息，<code>sendMessage</code>方法的代码如下所示。</p>
<p>源码:<code>frameworks/base/core/java/android/app/ActivityThread.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(<span class="keyword">int</span> what, Object obj, <span class="keyword">int</span> arg1, <span class="keyword">int</span> arg2, <span class="keyword">boolean</span> async)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">...省略代码专用...</span><br><span class="line"></span><br><span class="line">  mH.sendMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里<code>mH</code>指的是<code>H</code>，它是<code>ActivityThread</code>的内部类并继承<code>Handler</code>，<code>H</code>的代码如下所示。</p>
<p>源码:<code>frameworks/base/core/java/android/app/ActivityThread.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">H</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LAUNCH_ACTIVITY         = <span class="number">100</span>;</span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PAUSE_ACTIVITY          = <span class="number">101</span>;</span><br><span class="line">      </span><br><span class="line">...省略代码专用...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(TAG, <span class="string">"&gt;&gt;&gt; handling: "</span> + codeToString(msg.what));</span><br><span class="line">          <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">              <span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</span><br><span class="line">                  Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityStart"</span>);</span><br><span class="line">                  <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;<span class="comment">//1</span></span><br><span class="line">                  r.packageInfo = getPackageInfoNoCheck(</span><br><span class="line">                          r.activityInfo.applicationInfo, r.compatInfo);<span class="comment">//2</span></span><br><span class="line">                  handleLaunchActivity(r, <span class="keyword">null</span>, <span class="string">"LAUNCH_ACTIVITY"</span>);<span class="comment">//3</span></span><br><span class="line">                  Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">              &#125; <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> RELAUNCH_ACTIVITY: &#123;</span><br><span class="line">                  Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityRestart"</span>);</span><br><span class="line">                  ActivityClientRecord r = (ActivityClientRecord)msg.obj;</span><br><span class="line">                  handleRelaunchActivity(r);</span><br><span class="line">                  Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">              &#125; <span class="keyword">break</span>;</span><br><span class="line">              </span><br><span class="line">            ...省略代码专用...</span><br><span class="line">            </span><br><span class="line">&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>查看<code>H</code>的<code>handleMessage</code>方法中对<code>LAUNCH_ACTIVITY</code>的处理，在注释1处将传过来的<code>msg</code>的成员变量<code>obj</code>转换为<code>ActivityClientRecord</code>。<br>在注释2处通过<code>getPackageInfoNoCheck</code>方法获得<code>LoadedApk</code>类型的对象并赋值给<code>ActivityClientRecord</code>的成员变量<code>packageInfo</code>。应用程序进程要启动<code>Activity</code>时需要将该<code>Activity</code>所属的APK加载进来，而<code>LoadedApk</code>就是用来描述已加载的APK文件。<br>在注释3处调用<code>handleLaunchActivity</code>方法，代码如下所示。</p>
<p>源码:<code>frameworks/base/core/java/android/app/ActivityThread.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent, String reason)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...省略代码专用...</span><br><span class="line">    </span><br><span class="line">  Activity a = performLaunchActivity(r, customIntent);<span class="comment">//1</span></span><br><span class="line">  <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">      r.createdConfig = <span class="keyword">new</span> Configuration(mConfiguration);</span><br><span class="line">      reportSizeConfigurations(r);</span><br><span class="line">      Bundle oldState = r.state;</span><br><span class="line">      handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</span><br><span class="line">              !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason); <span class="comment">// ①</span></span><br><span class="line">      <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; r.startsNotResumed) &#123;      </span><br><span class="line">          performPauseActivityIfNeeded(r, reason);</span><br><span class="line">          <span class="keyword">if</span> (r.isPreHoneycomb()) &#123;</span><br><span class="line">              r.state = oldState;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          ActivityManagerNative.getDefault()</span><br><span class="line">              .finishActivity(r.token, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</span><br><span class="line">                      Activity.DONT_FINISH_TASK_WITH_ACTIVITY);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">          <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注释1处的<code>performLaunchActivity</code>方法用来启动<code>Activity</code> ，注释2处的代码用来将<code>Activity</code>的状态置为<code>Resume</code>。如果该<code>Activity</code>为<code>null</code>则会通知<code>ActivityManager</code>停止启动<code>Activity</code>。来查看<code>performLaunchActivity</code>方法做了什么：</p>
<p>源码:<code>frameworks/base/core/java/android/app/ActivityThread.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  ...省略代码专用...</span><br><span class="line">  </span><br><span class="line">    ActivityInfo aInfo = r.activityInfo; <span class="comment">// ①</span></span><br><span class="line">    <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">        r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">                 Context.CONTEXT_INCLUDE_CODE); <span class="comment">// ②</span></span><br><span class="line">    &#125;</span><br><span class="line">    ComponentName component = r.intent.getComponent(); <span class="comment">// ③</span></span><br><span class="line">    </span><br><span class="line">    ...省略代码专用...</span><br><span class="line">    </span><br><span class="line">    Activity activity = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">        activity = mInstrumentation.newActivity(</span><br><span class="line">                cl, component.getClassName(), r.intent); <span class="comment">// ④</span></span><br><span class="line">                </span><br><span class="line">        ...省略代码专用...</span><br><span class="line">        </span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    </span><br><span class="line">        ...省略代码专用...</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation); <span class="comment">// ⑤</span></span><br><span class="line">        </span><br><span class="line">        ...省略代码专用...</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">               Context appContext = createBaseContextForActivity(r, activity); <span class="comment">// ⑥</span></span><br><span class="line">               </span><br><span class="line">        ...省略代码专用...</span><br><span class="line">        </span><br><span class="line">        &#125;</span><br><span class="line">               <span class="comment">// ⑦</span></span><br><span class="line">               activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                     r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                    r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                    r.referrer, r.voiceInteractor, window);</span><br><span class="line">                    </span><br><span class="line">          ...省略代码专用...</span><br><span class="line">          </span><br><span class="line">              <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                  mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);<span class="comment">//8</span></span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">              &#125;</span><br><span class="line">              </span><br><span class="line">              ...省略代码专用...</span><br><span class="line">              </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注释1处用来获取<code>ActivityInfo</code>，在注释2处获取APK文件的描述类<code>LoadedApk</code>。注释3处获取要启动的<code>Activity</code>的<code>ComponentName</code>类，<code>ComponentName</code>类中保存了该<code>Activity</code>的包名和类名。注释4处根据<code>ComponentName</code>中存储的<code>Activity</code>类名，用类加载器来创建该<code>Activity</code>的实例。注释5处用来创建<code>Application</code>，<code>makeApplication</code>方法内部会调用<code>Application</code>的<code>onCreate</code>方法。注释6处用来创建要启动<code>Activity</code>的上下文环境。注释7处调用<code>Activity</code>的attach方法初始化<code>Activity</code>，<code>attach</code>方法中会创建<code>Window</code>对象（<code>PhoneWindow</code>）并与<code>Activity</code>自身进行关联。注释8处会调用<code>Instrumentation</code>的<code>callActivityOnCreate</code>方法来启动<code>Activity</code>：</p>
<p>源码:<code>frameworks/base/core/java/android/app/Instrumentation.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnCreate</span><span class="params">(Activity activity, Bundle icicle,</span></span></span><br><span class="line"><span class="function"><span class="params">         PersistableBundle persistentState)</span> </span>&#123;</span><br><span class="line">    prePerformCreate(activity);</span><br><span class="line">    activity.performCreate(icicle, persistentState); <span class="comment">// ①</span></span><br><span class="line">    postPerformCreate(activity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注释1处调用了<code>Activity</code>的<code>performCreate</code>方法，代码如下所示。</p>
<p>源码:<code>frameworks/base/core/java/android/app/Activity.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performCreate</span><span class="params">(Bundle icicle)</span> </span>&#123;</span><br><span class="line">    restoreHasCurrentPermissionRequest(icicle);</span><br><span class="line">    onCreate(icicle);</span><br><span class="line">    mActivityTransitionState.readState(icicle);</span><br><span class="line">    performCreateCommon();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>performCreate</code>方法中会调用<code>Activity</code>的<code>onCreate</code>方法，这样<code>Activity</code>就启动了，即应用程序就启动了。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/03/11/Retrofit源码分析/" class="prev">PREV</a><a href="/2017/02/12/algorithm-二分查找/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2020 <a href="http://daijinlin.com">J!nl!n</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>