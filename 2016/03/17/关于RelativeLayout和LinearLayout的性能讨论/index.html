<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 关于RelativeLayout和LinearLayout的性能讨论 · J!nl!n's Blog</title><meta name="description" content="关于RelativeLayout和LinearLayout的性能讨论 - J!nl!n"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://daijinlin.com/atom.xml" title="J!nl!n's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/5peak2me" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">关于RelativeLayout和LinearLayout的性能讨论</h1><div class="post-info">2016年3月17日</div><div class="post-content"><p>　　<strong> 概述：</strong>我们知道RelativeLayout和LinearLayout是Android中常用的布局，日常使用的再频繁不过。但是如果不正确使用会极大的影响性能，因此，正确的使用它们是提升程序性能的关键性工作。<br><a id="more"></a></p>
<h5 id="关于影响性能的重要因素"><a href="#关于影响性能的重要因素" class="headerlink" title="关于影响性能的重要因素"></a>关于影响性能的重要因素</h5><p>我们知道一个View要经历measure/layout/draw三大流程，这里不做详细叙述具体的可以查阅相关资料或者源码来学习。这里我们通过查看源码可以发现其主要的性能差异表现在<code>onMeasure</code>的逻辑上。</p>
<h5 id="LinearLayout的onMeasure源码"><a href="#LinearLayout的onMeasure源码" class="headerlink" title="LinearLayout的onMeasure源码"></a>LinearLayout的<code>onMeasure</code>源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mOrientation == VERTICAL) &#123;</div><div class="line">        measureVertical(widthMeasureSpec, heightMeasureSpec);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        measureHorizontal(widthMeasureSpec, heightMeasureSpec);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到LinearLayout先会判断我们所设置的布局方向，分别执行不同的测量逻辑。由此，我们可以推测其<code>onLayout</code>的逻辑应该也是会判断方向，这里就不做解释了。布局方向可以通过xml或者java设置。如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">android:orientation="vertical"</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">setOrientation(<span class="meta">@OrientationMode</span> <span class="keyword">int</span> orientation)</div></pre></td></tr></table></figure>
<p>我们这里只考虑竖直的方向情况，横向的原理类似，可自行查看源码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Measures the children when the orientation of this LinearLayout is set</div><div class="line"> * to &#123;<span class="doctag">@link</span> #VERTICAL&#125;.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> widthMeasureSpec Horizontal space requirements as imposed by the parent.</div><div class="line"> * <span class="doctag">@param</span> heightMeasureSpec Vertical space requirements as imposed by the parent.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@see</span> #getOrientation()</div><div class="line"> * <span class="doctag">@see</span> #setOrientation(int)</div><div class="line"> * <span class="doctag">@see</span> #onMeasure(int, int)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">measureVertical</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">    mTotalLength = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> maxWidth = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> childState = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> alternativeMaxWidth = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> weightedMaxWidth = <span class="number">0</span>;</div><div class="line">    <span class="keyword">boolean</span> allFillParent = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">float</span> totalWeight = <span class="number">0</span>; <span class="comment">// 初始化0</span></div><div class="line">    <span class="comment">// 获取子View的个数</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = getVirtualChildCount();</div><div class="line">    </div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> widthMode = MeasureSpec.getMode(widthMeasureSpec);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> heightMode = MeasureSpec.getMode(heightMeasureSpec);</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> matchWidth = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">boolean</span> skippedMeasure = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> baselineChildIndex = mBaselineAlignedChildIndex;        </div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> useLargestChild = mUseLargestChild;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> largestChildHeight = Integer.MIN_VALUE;</div><div class="line">    <span class="keyword">int</span> consumedExcessSpace = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">// See how tall everyone is. Also remember max width.</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</div><div class="line">        <span class="keyword">final</span> View child = getVirtualChildAt(i);</div><div class="line">        <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">            mTotalLength += measureNullChild(i);</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (child.getVisibility() == View.GONE) &#123;</div><div class="line">           i += getChildrenSkipCount(child, i);</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (hasDividerBeforeChildAt(i)) &#123;</div><div class="line">            mTotalLength += mDividerHeight;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line">        <span class="comment">// 如果都没有设置weight，则还是0，下面的布尔值为false</span></div><div class="line">        totalWeight += lp.weight;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> useExcessSpace = lp.height == <span class="number">0</span> &amp;&amp; lp.weight &gt; <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> (heightMode == MeasureSpec.EXACTLY &amp;&amp; useExcessSpace) &#123;</div><div class="line">            <span class="comment">// Optimization: don't bother measuring children who are only</span></div><div class="line">            <span class="comment">// laid out using excess space. These views will get measured</span></div><div class="line">            <span class="comment">// later if we have space to distribute.</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> totalLength = mTotalLength;</div><div class="line">            mTotalLength = Math.max(totalLength, totalLength + lp.topMargin + lp.bottomMargin);</div><div class="line">            skippedMeasure = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (useExcessSpace) &#123;</div><div class="line">                <span class="comment">// The heightMode is either UNSPECIFIED or AT_MOST, and</span></div><div class="line">                <span class="comment">// this child is only laid out using excess space. Measure</span></div><div class="line">                <span class="comment">// using WRAP_CONTENT so that we can find out the view's</span></div><div class="line">                <span class="comment">// optimal height. We'll restore the original height of 0</span></div><div class="line">                <span class="comment">// after measurement.</span></div><div class="line">                lp.height = LayoutParams.WRAP_CONTENT;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Determine how big this child would like to be. If this or</span></div><div class="line">            <span class="comment">// previous children have given a weight, then we allow it to</span></div><div class="line">            <span class="comment">// use all available space (and we will shrink things later</span></div><div class="line">            <span class="comment">// if needed).</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> usedHeight = totalWeight == <span class="number">0</span> ? mTotalLength : <span class="number">0</span>;</div><div class="line">            <span class="comment">// 第一次测量</span></div><div class="line">            measureChildBeforeLayout(child, i, widthMeasureSpec, <span class="number">0</span>, </div><div class="line">                    heightMeasureSpec, usedHeight); </div><div class="line"></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childHeight = child.getMeasuredHeight();</div><div class="line">            <span class="keyword">if</span> (useExcessSpace) &#123;</div><div class="line">                <span class="comment">// Restore the original height and record how much space</span></div><div class="line">                <span class="comment">// we've allocated to excess-only children so that we can</span></div><div class="line">                <span class="comment">// match the behavior of EXACTLY measurement.</span></div><div class="line">                lp.height = <span class="number">0</span>;</div><div class="line">                consumedExcessSpace += childHeight;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> totalLength = mTotalLength;</div><div class="line">            mTotalLength = Math.max(totalLength, totalLength + childHeight + lp.topMargin +</div><div class="line">                   lp.bottomMargin + getNextLocationOffset(child));</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (useLargestChild) &#123;</div><div class="line">                largestChildHeight = Math.max(childHeight, largestChildHeight);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * If applicable, compute the additional offset to the child's baseline</div><div class="line">         * we'll need later when asked &#123;<span class="doctag">@link</span> #getBaseline&#125;.</div><div class="line">         */</div><div class="line">        <span class="keyword">if</span> ((baselineChildIndex &gt;= <span class="number">0</span>) &amp;&amp; (baselineChildIndex == i + <span class="number">1</span>)) &#123;</div><div class="line">           mBaselineChildTop = mTotalLength;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// if we are trying to use a child index for our baseline, the above</span></div><div class="line">        <span class="comment">// book keeping only works if there are no children above it with</span></div><div class="line">        <span class="comment">// weight.  fail fast to aid the developer.</span></div><div class="line">        <span class="keyword">if</span> (i &lt; baselineChildIndex &amp;&amp; lp.weight &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"A child of LinearLayout with index "</span></div><div class="line">                    + <span class="string">"less than mBaselineAlignedChildIndex has weight &gt; 0, which "</span></div><div class="line">                    + <span class="string">"won't work.  Either remove the weight, or don't set "</span></div><div class="line">                    + <span class="string">"mBaselineAlignedChildIndex."</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> matchWidthLocally = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">if</span> (widthMode != MeasureSpec.EXACTLY &amp;&amp; lp.width == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">            <span class="comment">// The width of the linear layout will scale, and at least one</span></div><div class="line">            <span class="comment">// child said it wanted to match our width. Set a flag</span></div><div class="line">            <span class="comment">// indicating that we need to remeasure at least that view when</span></div><div class="line">            <span class="comment">// we know our width.</span></div><div class="line">            matchWidth = <span class="keyword">true</span>;</div><div class="line">            matchWidthLocally = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> margin = lp.leftMargin + lp.rightMargin;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> measuredWidth = child.getMeasuredWidth() + margin;</div><div class="line">        maxWidth = Math.max(maxWidth, measuredWidth);</div><div class="line">        childState = combineMeasuredStates(childState, child.getMeasuredState());</div><div class="line"></div><div class="line">        allFillParent = allFillParent &amp;&amp; lp.width == LayoutParams.MATCH_PARENT;</div><div class="line">        <span class="keyword">if</span> (lp.weight &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Widths of weighted Views are bogus if we end up</div><div class="line">             * remeasuring, so keep them separate.</div><div class="line">             */</div><div class="line">            weightedMaxWidth = Math.max(weightedMaxWidth,</div><div class="line">                    matchWidthLocally ? margin : measuredWidth);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            alternativeMaxWidth = Math.max(alternativeMaxWidth,</div><div class="line">                    matchWidthLocally ? margin : measuredWidth);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        i += getChildrenSkipCount(child, i);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mTotalLength &gt; <span class="number">0</span> &amp;&amp; hasDividerBeforeChildAt(count)) &#123;</div><div class="line">        mTotalLength += mDividerHeight;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (useLargestChild &amp;&amp;</div><div class="line">            (heightMode == MeasureSpec.AT_MOST || heightMode == MeasureSpec.UNSPECIFIED)) &#123;</div><div class="line">        mTotalLength = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</div><div class="line">            <span class="keyword">final</span> View child = getVirtualChildAt(i);</div><div class="line">            <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">                mTotalLength += measureNullChild(i);</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (child.getVisibility() == GONE) &#123;</div><div class="line">                i += getChildrenSkipCount(child, i);</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> LinearLayout.LayoutParams lp = (LinearLayout.LayoutParams)</div><div class="line">                    child.getLayoutParams();</div><div class="line">            <span class="comment">// Account for negative margins</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> totalLength = mTotalLength;</div><div class="line">            mTotalLength = Math.max(totalLength, totalLength + largestChildHeight +</div><div class="line">                    lp.topMargin + lp.bottomMargin + getNextLocationOffset(child));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Add in our padding</span></div><div class="line">    mTotalLength += mPaddingTop + mPaddingBottom;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> heightSize = mTotalLength;</div><div class="line"></div><div class="line">    <span class="comment">// Check against our minimum height</span></div><div class="line">    heightSize = Math.max(heightSize, getSuggestedMinimumHeight());</div><div class="line">    </div><div class="line">    <span class="comment">// Reconcile our calculated size with the heightMeasureSpec</span></div><div class="line">    <span class="keyword">int</span> heightSizeAndState = resolveSizeAndState(heightSize, heightMeasureSpec, <span class="number">0</span>);</div><div class="line">    heightSize = heightSizeAndState &amp; MEASURED_SIZE_MASK;</div><div class="line">    </div><div class="line">    <span class="comment">// Either expand children with weight to take up available space or</span></div><div class="line">    <span class="comment">// shrink them if they extend beyond our current bounds. If we skipped</span></div><div class="line">    <span class="comment">// measurement on any children, we need to measure them now.</span></div><div class="line">    <span class="keyword">int</span> remainingExcess = heightSize - mTotalLength</div><div class="line">            + (mAllowInconsistentMeasurement ? <span class="number">0</span> : consumedExcessSpace);</div><div class="line">    <span class="keyword">if</span> (skippedMeasure || remainingExcess != <span class="number">0</span> &amp;&amp; totalWeight &gt; <span class="number">0.0f</span>) &#123;</div><div class="line">        <span class="keyword">float</span> remainingWeightSum = mWeightSum &gt; <span class="number">0.0f</span> ? mWeightSum : totalWeight;</div><div class="line"></div><div class="line">        mTotalLength = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</div><div class="line">            <span class="keyword">final</span> View child = getVirtualChildAt(i);</div><div class="line">            <span class="keyword">if</span> (child == <span class="keyword">null</span> || child.getVisibility() == View.GONE) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line">            <span class="keyword">final</span> <span class="keyword">float</span> childWeight = lp.weight;</div><div class="line">            <span class="keyword">if</span> (childWeight &gt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> share = (<span class="keyword">int</span>) (childWeight * remainingExcess / remainingWeightSum);</div><div class="line">                remainingExcess -= share;</div><div class="line">                remainingWeightSum -= childWeight;</div><div class="line"></div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> childHeight;</div><div class="line">                <span class="keyword">if</span> (mUseLargestChild &amp;&amp; heightMode != MeasureSpec.EXACTLY) &#123;</div><div class="line">                    childHeight = largestChildHeight;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lp.height == <span class="number">0</span> &amp;&amp; (!mAllowInconsistentMeasurement</div><div class="line">                        || heightMode == MeasureSpec.EXACTLY)) &#123;</div><div class="line">                    <span class="comment">// This child needs to be laid out from scratch using</span></div><div class="line">                    <span class="comment">// only its share of excess space.</span></div><div class="line">                    childHeight = share;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// This child had some intrinsic height to which we</span></div><div class="line">                    <span class="comment">// need to add its share of excess space.</span></div><div class="line">                    childHeight = child.getMeasuredHeight() + share;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(</div><div class="line">                        Math.max(<span class="number">0</span>, childHeight), MeasureSpec.EXACTLY);</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(widthMeasureSpec,</div><div class="line">                        mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin,</div><div class="line">                        lp.width);</div><div class="line">                <span class="comment">// 第二次测量</span></div><div class="line">                child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line"></div><div class="line">                <span class="comment">// Child may now not fit in vertical dimension.</span></div><div class="line">                childState = combineMeasuredStates(childState, child.getMeasuredState()</div><div class="line">                        &amp; (MEASURED_STATE_MASK&gt;&gt;MEASURED_HEIGHT_STATE_SHIFT));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> margin =  lp.leftMargin + lp.rightMargin;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> measuredWidth = child.getMeasuredWidth() + margin;</div><div class="line">            maxWidth = Math.max(maxWidth, measuredWidth);</div><div class="line"></div><div class="line">            <span class="keyword">boolean</span> matchWidthLocally = widthMode != MeasureSpec.EXACTLY &amp;&amp;</div><div class="line">                    lp.width == LayoutParams.MATCH_PARENT;</div><div class="line"></div><div class="line">            alternativeMaxWidth = Math.max(alternativeMaxWidth,</div><div class="line">                    matchWidthLocally ? margin : measuredWidth);</div><div class="line"></div><div class="line">            allFillParent = allFillParent &amp;&amp; lp.width == LayoutParams.MATCH_PARENT;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> totalLength = mTotalLength;</div><div class="line">            mTotalLength = Math.max(totalLength, totalLength + child.getMeasuredHeight() +</div><div class="line">                    lp.topMargin + lp.bottomMargin + getNextLocationOffset(child));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Add in our padding</span></div><div class="line">        mTotalLength += mPaddingTop + mPaddingBottom;</div><div class="line">        <span class="comment">// <span class="doctag">TODO:</span> Should we recompute the heightSpec based on the new total length?</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        alternativeMaxWidth = Math.max(alternativeMaxWidth,</div><div class="line">                                       weightedMaxWidth);</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">// We have no limit, so make all weighted views as tall as the largest child.</span></div><div class="line">        <span class="comment">// Children will have already been measured once.</span></div><div class="line">        <span class="keyword">if</span> (useLargestChild &amp;&amp; heightMode != MeasureSpec.EXACTLY) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">                <span class="keyword">final</span> View child = getVirtualChildAt(i);</div><div class="line">                <span class="keyword">if</span> (child == <span class="keyword">null</span> || child.getVisibility() == View.GONE) &#123;</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">final</span> LinearLayout.LayoutParams lp =</div><div class="line">                        (LinearLayout.LayoutParams) child.getLayoutParams();</div><div class="line"></div><div class="line">                <span class="keyword">float</span> childExtra = lp.weight;</div><div class="line">                <span class="keyword">if</span> (childExtra &gt; <span class="number">0</span>) &#123;</div><div class="line">                    child.measure(</div><div class="line">                            MeasureSpec.makeMeasureSpec(child.getMeasuredWidth(),</div><div class="line">                                    MeasureSpec.EXACTLY),</div><div class="line">                            MeasureSpec.makeMeasureSpec(largestChildHeight,</div><div class="line">                                    MeasureSpec.EXACTLY));</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!allFillParent &amp;&amp; widthMode != MeasureSpec.EXACTLY) &#123;</div><div class="line">        maxWidth = alternativeMaxWidth;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    maxWidth += mPaddingLeft + mPaddingRight;</div><div class="line"></div><div class="line">    <span class="comment">// Check against our minimum width</span></div><div class="line">    maxWidth = Math.max(maxWidth, getSuggestedMinimumWidth());</div><div class="line">    </div><div class="line">    setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState),</div><div class="line">            heightSizeAndState);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (matchWidth) &#123;</div><div class="line">        forceUniformWidth(count, heightMeasureSpec);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以发现，Linearlayout会先对所有的子View进行计算totalWeight（所有子View的weight属性之和），然后判断子View的weight属性是否为最大，如为最大则将剩余的空间分配给它。如果不使用weight的话，则不会进行第二次measure的操作。</p>
<h5 id="来看下RelativeLayout的onMeasure源码"><a href="#来看下RelativeLayout的onMeasure源码" class="headerlink" title="来看下RelativeLayout的onMeasure源码"></a>来看下RelativeLayout的<code>onMeasure</code>源码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mDirtyHierarchy) &#123;</div><div class="line">        mDirtyHierarchy = <span class="keyword">false</span>;</div><div class="line">        sortChildren();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> myWidth = -<span class="number">1</span>;</div><div class="line">    <span class="keyword">int</span> myHeight = -<span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> width = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> height = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> widthMode = MeasureSpec.getMode(widthMeasureSpec);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> heightMode = MeasureSpec.getMode(heightMeasureSpec);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> widthSize = MeasureSpec.getSize(widthMeasureSpec);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> heightSize = MeasureSpec.getSize(heightMeasureSpec);</div><div class="line"></div><div class="line">    <span class="comment">// Record our dimensions if they are known;</span></div><div class="line">    <span class="keyword">if</span> (widthMode != MeasureSpec.UNSPECIFIED) &#123;</div><div class="line">        myWidth = widthSize;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (heightMode != MeasureSpec.UNSPECIFIED) &#123;</div><div class="line">        myHeight = heightSize;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (widthMode == MeasureSpec.EXACTLY) &#123;</div><div class="line">        width = myWidth;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (heightMode == MeasureSpec.EXACTLY) &#123;</div><div class="line">        height = myHeight;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    View ignore = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">int</span> gravity = mGravity &amp; Gravity.RELATIVE_HORIZONTAL_GRAVITY_MASK;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> horizontalGravity = gravity != Gravity.START &amp;&amp; gravity != <span class="number">0</span>;</div><div class="line">    gravity = mGravity &amp; Gravity.VERTICAL_GRAVITY_MASK;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> verticalGravity = gravity != Gravity.TOP &amp;&amp; gravity != <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> left = Integer.MAX_VALUE;</div><div class="line">    <span class="keyword">int</span> top = Integer.MAX_VALUE;</div><div class="line">    <span class="keyword">int</span> right = Integer.MIN_VALUE;</div><div class="line">    <span class="keyword">int</span> bottom = Integer.MIN_VALUE;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> offsetHorizontalAxis = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">boolean</span> offsetVerticalAxis = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((horizontalGravity || verticalGravity) &amp;&amp; mIgnoreGravity != View.NO_ID) &#123;</div><div class="line">        ignore = findViewById(mIgnoreGravity);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isWrapContentWidth = widthMode != MeasureSpec.EXACTLY;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isWrapContentHeight = heightMode != MeasureSpec.EXACTLY;</div><div class="line"></div><div class="line">    <span class="comment">// We need to know our size for doing the correct computation of children positioning in RTL</span></div><div class="line">    <span class="comment">// mode but there is no practical way to get it instead of running the code below.</span></div><div class="line">    <span class="comment">// So, instead of running the code twice, we just set the width to a "default display width"</span></div><div class="line">    <span class="comment">// before the computation and then, as a last pass, we will update their real position with</span></div><div class="line">    <span class="comment">// an offset equals to "DEFAULT_WIDTH - width".</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> layoutDirection = getLayoutDirection();</div><div class="line">    <span class="keyword">if</span> (isLayoutRtl() &amp;&amp; myWidth == -<span class="number">1</span>) &#123;</div><div class="line">        myWidth = DEFAULT_WIDTH;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 获取横向的子View</span></div><div class="line">    View[] views = mSortedHorizontalChildren;</div><div class="line">    <span class="keyword">int</span> count = views.length;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        View child = views[i];</div><div class="line">        <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">            LayoutParams params = (LayoutParams) child.getLayoutParams();</div><div class="line">            <span class="keyword">int</span>[] rules = params.getRules(layoutDirection);</div><div class="line"></div><div class="line">            applyHorizontalSizeRules(params, myWidth, rules);</div><div class="line">            <span class="comment">// 横向测量子View</span></div><div class="line">            measureChildHorizontal(child, params, myWidth, myHeight);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (positionChildHorizontal(child, params, myWidth, isWrapContentWidth)) &#123;</div><div class="line">                offsetHorizontalAxis = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 获取纵向的子View</span></div><div class="line">    views = mSortedVerticalChildren;</div><div class="line">    count = views.length;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> targetSdkVersion = getContext().getApplicationInfo().targetSdkVersion;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        <span class="keyword">final</span> View child = views[i];</div><div class="line">        <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">            <span class="keyword">final</span> LayoutParams params = (LayoutParams) child.getLayoutParams();</div><div class="line"></div><div class="line">            applyVerticalSizeRules(params, myHeight, child.getBaseline());</div><div class="line">            <span class="comment">// 纵向测量子View</span></div><div class="line">            measureChild(child, params, myWidth, myHeight);</div><div class="line">            <span class="keyword">if</span> (positionChildVertical(child, params, myHeight, isWrapContentHeight)) &#123;</div><div class="line">                offsetVerticalAxis = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (isWrapContentWidth) &#123;</div><div class="line">                <span class="keyword">if</span> (isLayoutRtl()) &#123;</div><div class="line">                    <span class="keyword">if</span> (targetSdkVersion &lt; Build.VERSION_CODES.KITKAT) &#123;</div><div class="line">                        width = Math.max(width, myWidth - params.mLeft);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        width = Math.max(width, myWidth - params.mLeft - params.leftMargin);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (targetSdkVersion &lt; Build.VERSION_CODES.KITKAT) &#123;</div><div class="line">                        width = Math.max(width, params.mRight);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        width = Math.max(width, params.mRight + params.rightMargin);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (isWrapContentHeight) &#123;</div><div class="line">                <span class="keyword">if</span> (targetSdkVersion &lt; Build.VERSION_CODES.KITKAT) &#123;</div><div class="line">                    height = Math.max(height, params.mBottom);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    height = Math.max(height, params.mBottom + params.bottomMargin);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (child != ignore || verticalGravity) &#123;</div><div class="line">                left = Math.min(left, params.mLeft - params.leftMargin);</div><div class="line">                top = Math.min(top, params.mTop - params.topMargin);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (child != ignore || horizontalGravity) &#123;</div><div class="line">                right = Math.max(right, params.mRight + params.rightMargin);</div><div class="line">                bottom = Math.max(bottom, params.mBottom + params.bottomMargin);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Use the top-start-most laid out view as the baseline. RTL offsets are</span></div><div class="line">    <span class="comment">// applied later, so we can use the left-most edge as the starting edge.</span></div><div class="line">    View baselineView = <span class="keyword">null</span>;</div><div class="line">    LayoutParams baselineParams = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        <span class="keyword">final</span> View child = views[i];</div><div class="line">        <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">            <span class="keyword">final</span> LayoutParams childParams = (LayoutParams) child.getLayoutParams();</div><div class="line">            <span class="keyword">if</span> (baselineView == <span class="keyword">null</span> || baselineParams == <span class="keyword">null</span></div><div class="line">                    || compareLayoutPosition(childParams, baselineParams) &lt; <span class="number">0</span>) &#123;</div><div class="line">                baselineView = child;</div><div class="line">                baselineParams = childParams;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    mBaselineView = baselineView;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (isWrapContentWidth) &#123;</div><div class="line">        <span class="comment">// Width already has left padding in it since it was calculated by looking at</span></div><div class="line">        <span class="comment">// the right of each child view</span></div><div class="line">        width += mPaddingRight;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mLayoutParams != <span class="keyword">null</span> &amp;&amp; mLayoutParams.width &gt;= <span class="number">0</span>) &#123;</div><div class="line">            width = Math.max(width, mLayoutParams.width);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        width = Math.max(width, getSuggestedMinimumWidth());</div><div class="line">        width = resolveSize(width, widthMeasureSpec);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (offsetHorizontalAxis) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">                <span class="keyword">final</span> View child = views[i];</div><div class="line">                <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">                    <span class="keyword">final</span> LayoutParams params = (LayoutParams) child.getLayoutParams();</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span>[] rules = params.getRules(layoutDirection);</div><div class="line">                    <span class="keyword">if</span> (rules[CENTER_IN_PARENT] != <span class="number">0</span> || rules[CENTER_HORIZONTAL] != <span class="number">0</span>) &#123;</div><div class="line">                        centerHorizontal(child, params, width);</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rules[ALIGN_PARENT_RIGHT] != <span class="number">0</span>) &#123;</div><div class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> childWidth = child.getMeasuredWidth();</div><div class="line">                        params.mLeft = width - mPaddingRight - childWidth;</div><div class="line">                        params.mRight = params.mLeft + childWidth;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (isWrapContentHeight) &#123;</div><div class="line">        <span class="comment">// Height already has top padding in it since it was calculated by looking at</span></div><div class="line">        <span class="comment">// the bottom of each child view</span></div><div class="line">        height += mPaddingBottom;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mLayoutParams != <span class="keyword">null</span> &amp;&amp; mLayoutParams.height &gt;= <span class="number">0</span>) &#123;</div><div class="line">            height = Math.max(height, mLayoutParams.height);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        height = Math.max(height, getSuggestedMinimumHeight());</div><div class="line">        height = resolveSize(height, heightMeasureSpec);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (offsetVerticalAxis) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">                <span class="keyword">final</span> View child = views[i];</div><div class="line">                <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">                    <span class="keyword">final</span> LayoutParams params = (LayoutParams) child.getLayoutParams();</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span>[] rules = params.getRules(layoutDirection);</div><div class="line">                    <span class="keyword">if</span> (rules[CENTER_IN_PARENT] != <span class="number">0</span> || rules[CENTER_VERTICAL] != <span class="number">0</span>) &#123;</div><div class="line">                        centerVertical(child, params, height);</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rules[ALIGN_PARENT_BOTTOM] != <span class="number">0</span>) &#123;</div><div class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> childHeight = child.getMeasuredHeight();</div><div class="line">                        params.mTop = height - mPaddingBottom - childHeight;</div><div class="line">                        params.mBottom = params.mTop + childHeight;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (horizontalGravity || verticalGravity) &#123;</div><div class="line">        <span class="keyword">final</span> Rect selfBounds = mSelfBounds;</div><div class="line">        selfBounds.set(mPaddingLeft, mPaddingTop, width - mPaddingRight,</div><div class="line">                height - mPaddingBottom);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> Rect contentBounds = mContentBounds;</div><div class="line">        Gravity.apply(mGravity, right - left, bottom - top, selfBounds, contentBounds,</div><div class="line">                layoutDirection);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> horizontalOffset = contentBounds.left - left;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> verticalOffset = contentBounds.top - top;</div><div class="line">        <span class="keyword">if</span> (horizontalOffset != <span class="number">0</span> || verticalOffset != <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">                <span class="keyword">final</span> View child = views[i];</div><div class="line">                <span class="keyword">if</span> (child.getVisibility() != GONE &amp;&amp; child != ignore) &#123;</div><div class="line">                    <span class="keyword">final</span> LayoutParams params = (LayoutParams) child.getLayoutParams();</div><div class="line">                    <span class="keyword">if</span> (horizontalGravity) &#123;</div><div class="line">                        params.mLeft += horizontalOffset;</div><div class="line">                        params.mRight += horizontalOffset;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (verticalGravity) &#123;</div><div class="line">                        params.mTop += verticalOffset;</div><div class="line">                        params.mBottom += verticalOffset;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (isLayoutRtl()) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> offsetWidth = myWidth - width;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">            <span class="keyword">final</span> View child = views[i];</div><div class="line">            <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">                <span class="keyword">final</span> LayoutParams params = (LayoutParams) child.getLayoutParams();</div><div class="line">                params.mLeft -= offsetWidth;</div><div class="line">                params.mRight -= offsetWidth;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    setMeasuredDimension(width, height);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面注释的核心代码可以看出RelativeLayout作为复杂布局的根布局分别会对所有的子View进行横竖两次测量。</p>
<h5 id="正确使用结论"><a href="#正确使用结论" class="headerlink" title="正确使用结论"></a>正确使用结论</h5><p>根据以上的分析结果，那么我们知道如果使用RelativeLayout或者使用LinearLayout并且使用weight作为根布局，并且其子View的嵌套复杂层级较深的话。这里注意，尤其像列表空间诸如ListView或者RecyclerView的子Item等，就会对性能造成一定的影响。一般的我们不推荐使用RelativeLayout作为复杂布局的根布局。当然Google就为了解决这一问题新引入了约束布局（ConstraintLayout）的概念。ConstraintLayout极大的减少了层级嵌套使复杂的View变得简单。关于ConstraintLayout的介绍和使用后续会写博文具体描述。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2016/03/03/Android绘制文本细节整理/" class="prev">上一篇</a><a href="/2016/04/01/Android-hotfix-0/" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2017 <a href="http://daijinlin.com">J!nl!n</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>